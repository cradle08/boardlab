#!/bin/bash
#author: Alan Huang, Justin Zhao
#date 12/10/2015
#Description: this is the pdu control script
#

. check_board
POWER_CMD=ap7921-control

POWER=${boardinfo#*power=}
POWER=${POWER%%,*}

OUTLET=`echo $POWER | cut -d " " -f2`
POWER=`echo $POWER | cut -d " " -f1`

# Check whether the power controller is deployed
grep -w "$POWER:" $BOARDCFG >/dev/null 2>&1
if [ $? != 0 ];then
    echo "Power$BOARDIDX is not deployed into Open Lab, please touch the Lab. manager."
    exit 1
fi

# Get the power controller information
powerinfo=`grep -w "$POWER:" $BOARDCFG`
PDU_HOST=${powerinfo#*ip=}
PDU_HOST=${PDU_HOST%%,*}

usage()
{
    echo "Usage: board_reboot [Num] [on|off|reboot]"
    echo "To power on, off or reboot specify boards, default to reboot board1 without any parameters!"
    echo "    Num:            To operate the specified board assigned to user, Num is an interger board index which must be greater than 0, default to operate board1."
    echo "    on|off|reboot:  To specify a power operation, default to reboot."
    exit 0
} 

board_op()
{
	OPER=3

	case $1 in 
	"on")
		OPER=1
		;;
	"off")
		OPER=2
		;;
	"reboot")
		OPER=3
		;;
	*)
		usage
        exit
		;;
	esac

# Check the whether the board is being used, and send the operation command
    current=`ps -o ruser=userForLongName -e -o pid,ppid,c,stime,tty,time,cmd | grep telnet | grep $PORT | cut -d " " -f1`
    current=`echo $current|cut -d "+" -f1`
    if [ "$current" = "" ];then
	    $POWER_CMD $PDU_HOST $OUTLET $OPER
		echo ""
    else
        current_user=`grep -w $current $USERCFG|cut -d ":" -f1`
        if [ "$current_user" = "$USERNAME" ];then
	        $POWER_CMD $PDU_HOST $OUTLET $OPER
			echo ""
        else
            email=`grep -w $current $USERCFG`
            email=${email#*email=}
            email=${email%%,*}
            echo "              ********WARNING********"
            echo "  $email is using the board on $PORT"
            echo "  Please wait until he/she  finishes the work"
            echo "  Or you can contact with him by email."
        fi
    fi
	exit 0
}

if [ $# = 2 ]; then
    if [ "$1" -gt 0 ] 2>/dev/null ; then
        board_op $2
    else
        usage
    fi
    exit
else 
    if [ $# -gt 1 ]; then
    	usage
        exit
    fi

    
    if [ $# = 1 ]; then
        if [ "$1" -gt 0 ] 2>/dev/null ; then
            board_op reboot
        else
            case $1 in
            "on"|"off"|"reboot")
                board_op $1
                ;;
            *)
                usage
                ;;
            esac
        fi
        exit
    fi
fi

#default to reboot board1
board_op reboot
